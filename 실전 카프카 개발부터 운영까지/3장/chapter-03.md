# 카프카 기본 개념과 구조

## 카프카 기초 다지기
### 카프카를 구성하는 주요 요소
* 주키퍼: 카프카의 메타데이터 관리 및 브로커의 정상상태 점검(health check)
* 카프카 또는 카프카 클러스터: 여러 대의 브로커를 구성한 클러스터
* 브로커: 카프카 애플리케이션이 설치된 서버 또는 노드
* 프로듀서: 카프카로 메시지를 보내는 역할을 하는 클라이언트
* 컨슈머: 카프카에서 메시지를 꺼내가는 역할을 하는 클라이언트
* 토픽: 카프카는 메시지 피드들을 토픽으로 구분하고, 각 토픽의 이름은 카프카 내에서 고유함
* 파티션: 병렬 처리 및 고성능을 얻기 위해 하나의 토픽을 여러 개로 나눈 것
* 세그먼트: 프로듀서가 전송한 실제 메시지가 브로커의 로컬 디스크에 저장되는 파일
* 메시지 or 레코드: 프로듀서가 브로커로 전송하거나 컨슈머가 읽어가는 데이터 조각

### Replication
![--partition 4, --replication-factor 3](https://cdn.confluent.io/wp-content/uploads/2016/08/fig22.jpg)    
--partition 4, --replication-factor 3


* 각 메시지들을 여러 개로 복제해서 카프카 클러스터 내 브로커들에게 분산시키는 동작
    * 하나의 브로커가 종료되더라도 카프카는 안정성 유지
* replication-factor 옵션: 카프카 내에서 유지할 리플리케이션 개수
    * 토픽이 리플리케이션되는 것 X ⇒ 토픽의 파티션이 리플리케이션되는 것
* 리플리케이션 팩터 수가 클 경우: 안정성 증가, 그만큼 브로커 리소스 사용 또한 증가
    * 복제에 대한 오버헤드를 줄여서 최대한 브로커를 효율적으로 사용하는 것 권장
* 토픽 생성시 효율적인 운영을 위해 세워둘 수 있는 기준
    * 테스트나 개발 환경: 리플리케이션 팩터 수를 1개로 설정
    * 운영 환경(로그성 메시지로서 약간의 유실 허용): 리플리케이션 팩터 수를 2로 설정
    * 운영 환경(유실 허용하지 않음): 리플리케이션 팩터 수를 3으로 설정
* 안정성을 높이고자 리플리케이션 팩터 수를 4또는 5 그 이상으로도 설정할 수 있다. But, 리플리케이션 팩터 수가 3일 경우에도 충분히 메시지 안정성도 보장하고 적절한 디스크 공간을 사용할 수 있음(더 사용 시 디스크 리소스를 추가 점유)

### 파티션
* 파티션: 토픽 하나를 여러개로 나눠서 병렬 처리가 가능하게 만든 것
    * 하나의 토픽이 한 번에 처리할 수 있는 한계를 높이기 위함
    * 여러 개일 경우 장점
        * 분산 처리 가능
        * 파티션 수 만큼 컨슈머 연결 가능

![](https://velog.velcdn.com/images%2Fhyundong_kk%2Fpost%2F9cff0f84-0a90-4da6-8934-2da91911d37a%2Fimage.png)
![](https://www.oreilly.com/library/view/kafka-the-definitive/9781491936153/assets/ktdg_04in04.png)    
카프카 클러스터에 있는 토픽을 파티션으로 나눈 그림(파티션은 0부터 시작)
* 파티션 수 설정
    * 파티션 수도 토픽 생성 시 옵션으로 설정 가능
        * 파티션 수를 정하는 기준이 다소 모호함
        * 각 메시지 크기나 초당 메시지 건수등에 따라 달라지므로 정확하게 예측하기 힘듬
    * 늘리는 건 언제든지 가능
        * 한 번 늘린 파티션 수는 절대 줄일 수 없다
* 유려하게 운영하는 방법
    * 초기에 토픽을 생성할 때 파티션 수를 작게(2~4) 설정 → 메시지 처리량이나 컨슈머의 LAG등을 모니터링하면서 조금씩 늘려가는 방법이 베스트
    * (컨슈머의 LAG: 지연 지표로서, 프로듀서가 보낸 메시지 수(카프카에 남은) - 컨슈머가 가져간 메시지 수)

### 세그먼트
* 메시지 통신의 과정
    * 프로듀서(클라이언트) → 카프카의 토픽(브로커) → 컨슈머(클라이언트)
    * 메시지의 저장 위치는 각 브로커 서버 안에 존재
```
[ec2-user@ip-172-31-5-59 ~] cd /data/kafka-logs/
[ec2-user@ip-172-31-5-59 kafka-logs] ls

__consumer_offsets-0   __consumer_offsets-34
...
__consumer_offsets-28  __consumer_offsets-9
__consumer_offsets-29  cleaner-offset-checkpoint
__consumer_offsets-3   log-start-offset-checkpoint
__consumer_offsets-30  meta.properties
__consumer_offsets-31  peter-overview01-0
__consumer_offsets-32  recovery-point-offset-checkpoint
__consumer_offsets-33  replication-offset-checkpoint
```
* `peter-overview01-0`디렉토리
    * peter-overview01: 토픽
    * 0: 파티션 순서
* 하나의 토픽과 파티션에 대한 데이터를 디렉토리명으로 확인 가능
```
[ec2-user@ip-172-31-5-59 kafka-logs] cd peter-overview01-0/
[ec2-user@ip-172-31-5-59 peter-overview01-0] ls

00000000000000000000.index  00000000000000000000.timeindex
00000000000000000000.log    leader-epoch-checkpoint
```

* 00000000000000000000.log 확인
```
[ec2-user@ip-172-31-5-59 peter-overview01-0] xxd 00000000000000000000.log

00000000: 0000 0000 0000 0000 0000 0046 0000 0000  ...........F....
00000010: 021b 0d89 3f00 0000 0000 0000 0001 7e1f  ....?.........~.
00000020: ecc2 a000 0001 7e1f ecc2 a0ff ffff ffff  ......~.........
00000030: ffff ffff ffff ffff ff00 0000 0128 0000  .............(..
00000040: 0001 1c20 4669 7273 7420 6d65 7373 6167  ... First messag
00000050: 6500                                     e.
```
* First message 존재(2장에서 send한 데이터)

![](https://miro.medium.com/max/720/1*RQlk_aKjeTlwJn68llhX7A.png)
* 프로듀서를 이용해 보낸 메시지 ⇒ 토픽의 파티션0에 저장됨
    * 프로듀서에 의해 브로커로 전송된 메시지는 토픽의 파티션 0에 저장됨(2장에서 파티션 1개로 생성함)
      각 메시지들은 세그먼트라는 로그 파일(00000000000000000000.log)의 형태로 브로커의 로컬 디스크에 저장됨
* 각 파티션마다 N개의 세그먼트 로그 파일들이 존재
* 세그먼트의 파일 내용을 출력해봄으로써 프로듀서가 전송한 메시지가 브로커의 로컬 디스크에 안전하게 저장된 것을 확인 가능

## 카프카 핵심 개념

* 카프카: 높은 처리량, 빠른 응답 속도, 높은 안정성 제공
* 카프카가 왜 그렇게 안정적인지 그리고 어떻게 높은 처리량을 갖게 되었는지 이와 관련된 구체적인 내용들은 잘 알려지지 않음

### 분산 시스템
* 네트워크상에서 연결된 컴퓨터들의 그룹
* 단일 시스템이 갖지 못한 높은 성능을 목표로 여러 컴퓨터들을 통해 작업 처리
* 장점
    * 높은 처리량, 장애 대응 탁월
    * 부하가 높은 경우에는 시스템 확장까지 용이
* 카프카: 클러스터로 이루어진 분산 시스템
    * 최초 구성한 클러스터의 리소스가 한계치에 도달해 더욱 높은 메시지 처리량이 필요한 경우 브로커를 추가하는 방식으로 확장 가능
    * Ex) 최초 3대 브로커 → 30~50대, 혹은 그 이상으로 확장 가능